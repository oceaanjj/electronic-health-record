(function(){function l(){if(!document.getElementById("patient-select-form")){console.warn("Intake/Output Data Loader: #patient-select-form not found.");return}const d=document.getElementById("day_no_selector"),e=document.getElementById("patient_id_hidden"),n=document.getElementById("io-form");if(!d||!e||!n){console.error("Intake/Output Data Loader: Missing one or more required elements (date, day, patient_id hidden input, or io-form).");return}const m=document.querySelector(".searchable-dropdown"),p=m?m.dataset.selectUrl:null,v=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content");if(!p||!v){console.error("Intake/Output Data Loader: Form missing action URL or CSRF token not found.");return}const c=async()=>{const a=e.value,o=d.value;if(!a){console.log("No patient selected, skipping data fetch.");return}console.log(`Fetching data for Patient ID: ${a}, Day No: ${o}`);try{const r=await fetch(p,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":v,"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({patient_id:a,day_no:o})});if(!r.ok)throw new Error(`Server error: ${r.status}`);const t=await r.json();console.log("Received data:",t);const i=n.querySelector('[name="oral_intake"]'),u=n.querySelector('[name="iv_fluids_volume"]'),s=n.querySelector('[name="urine_output"]');i&&(i.value=t.ioData?.oral_intake??""),u&&(u.value=t.ioData?.iv_fluids_volume??""),s&&(s.value=t.ioData?.urine_output??"");const y=n.querySelector('input[name="day_no"]');y&&(y.value=t.currentDayNo);const I=new CustomEvent("io:data-loaded",{detail:{ioData:t.ioData}});document.dispatchEvent(I),document.dispatchEvent(new CustomEvent("cdss:form-reloaded",{bubbles:!0,detail:{formContainer:document.getElementById("form-content-container")}}))}catch(r){console.error("Error fetching intake and output data:",r);const t=n.querySelector('[name="oral_intake"]'),i=n.querySelector('[name="iv_fluids_volume"]'),u=n.querySelector('[name="urine_output"]');t&&(t.value=""),i&&(i.value=""),u&&(u.value="");const s=new CustomEvent("io:data-loaded",{detail:{ioData:null}});document.dispatchEvent(s),document.dispatchEvent(new CustomEvent("cdss:form-reloaded",{bubbles:!0,detail:{formContainer:document.getElementById("form-content-container")}}))}};d.removeEventListener("change",c),d.addEventListener("change",c),e._mutationObserver&&e._mutationObserver.disconnect();const f=new MutationObserver(a=>{a.forEach(o=>{o.type==="attributes"&&o.attributeName==="value"&&e.value&&o.oldValue!==e.value&&c()})});f.observe(e,{attributes:!0,attributeFilter:["value"]}),e._mutationObserver=f,e.value&&c()}window.initializeIntakeOutputDataLoader=l,document.addEventListener("DOMContentLoaded",l)})();
